---
title: "Behavioral Health Population-based Measures"
subtitle: ""
---

```{r}
#| label: setup
#| echo: false
#| error: false
#| message: false
#| warning: false
#| include: false

# -----------------------------------------------------------------------------
# 1. Setup/Dependencies (Package Manager)
# -----------------------------------------------------------------------------

if (!require("pacman")) {
  install.packages("pacman", repos = "https://cran.rstudio.org")
}
library(pacman)

# -----------------------------------------------------------------------------
# 2. Package Loading (Streamlined and Reorganized)
# -----------------------------------------------------------------------------

# Core/Essential Packages (General R use)
p_load(
  here,          # Folder/file management
  conflicted,    # Package conflict management
  english,       # Translate integers into text
  labelled,      # Manipulate variable/value metadata
  rlang,         # Functions for base R and tidyverse features
  xfun,          # Miscellaneous functions
  rio,           # Universal import/export
  archive,       # Archive files
  filesstrings,  # String manipulation
  googledrive,   # Interact with Google Drive
  reprex,        # Reproducible examples
  knitr        # Dynamic report generation
)

# Data Manipulation and Transformation (Tidyverse first, then others)
p_load(
  tidyverse,      # Tidy data handling and analysis (includes dplyr, tidyr, ggplot2, etc.)
  janitor,       # Data cleaning and examination
  bestNormalize, # Data normalization
  mice,          # Multivariate imputation
  skimr          # Summary statistics
)

# Tables
p_load(
  gt,            # Presentation-ready tables
  gtsummary,     # Publication-ready tables
  gtExtras,      # Additional gt functions
  flextable      # MS Office compatible tables
)

# Survey Analysis
p_load(
  survey,        # Survey analysis
  srvyr,         # Survey analysis
  anesrake       # ANES Raking
)

# Spatial Analysis (sf preferred, then others)
p_load(
  sf,            # Simple features (primary spatial package)
  sfd,           # Space-Filling Design Library
  sftime,        # Simple Features Time Series
  spdep,         # Spatial dependence
  raster,        # Raster data handling
  CARBayes,      # Bayesian spatial modeling
  tidycensus,    # US Census data
  tidygeocoder,  # Geocoding
  geojsonio,     # GeoJSON/TopoJSON conversion
  geogrid,       # Geospatial data
  ggspatial,     # Spatial visualization
  tmap,          # Thematic maps
  tmaptools,     # Thematic map tools
  osmdata,       # OpenStreetMap data
  OpenStreetMap, # OpenStreetMap data
  ggmap,         # Spatial visualization (Consider if needed with tmap)
  maptiles,      # Map tiles
  tidyterra,     # OpenStreetMap data
  tigris,        # US Census TIGER/Line shapefiles
  maps          # Draw geographical maps (Consider if needed with sf/tmap)
)

# Time Series
p_load(
  xts,           # Extensible time series
  spacetime,     # Spatio-temporal data
  tsibble,       # Tidy temporal data frames
  slider,        # Sliding window functions
  imputeTS,      # Time series imputation
  feasts,        # Time series feature extraction
  forecast,      # Time series forecasting
  trending,      # Trending analysis
  tibbletime     # Time-aware tibbles
)

# Visualization (ggplot2 related first)
p_load(
  scales,        # Graphical scales (often used with ggplot2)
  systemfonts,   # System fonts
  extrafont,     # Font management
  showtext,      # Easy font use in plots
  patchwork,     # Plot composition
  ggpp,          # ggplot2 extensions
  ggExtra,       # ggplot2 enhancements
  ggalt,         # Extra ggplot2 geoms/stats
  ggpubr,        # Easy plot creation
  ggridges,      # Ridgeline plots
  ggfittext,     # Improved text rendering
  ggtext,         # Improved text rendering
  ggthemes,       # ggplot2 themes
  ggsci,          # ggplot2 color palettes
  scico,          # Scientific color maps
  hrbrthemes,     # ggplot2 themes
  viridis         # ggplot2 color palettes
)

# Visualization (GitHub)
p_load_gh(
  "AliciaSchep/gglabeller",       # Easy plot labeling
  "MarcellGranat/ggProfessional", # Professional ggplot2
  "mattcowgill/ggannotate",       # Easy plot annotation
  "amirmasoudabdol/sfthemes"     # Simple features themes
)

# Visualization (Other)
p_load(
  # extrafont,  # Font tools (Consider if needed with showtext)
  magick,        # Image processing (Consider if actively used)
  xkcd,          # xkcd theme (Consider if actively used)
  harrypotter    # Harry Potter theme (Consider if actively used)
)

# Compatibility & Other
p_load(
  officedown,    # Microsoft Office compatibility
  DBI,           # Database interaction
  units,         # Measurement units
  yardstick,     # Model metrics
  surveillance   # Epidemic modeling
)

# -----------------------------------------------------------------------------
# 3. Conflict Resolution (After loading)
# -----------------------------------------------------------------------------

conflicts_prefer(
  dplyr::filter, 
  dplyr::first,
  dplyr::summarize, 
  dplyr::select, 
  janitor::clean_names,
  lubridate::year, 
  rio::export,
  tidyselect::starts_with,
  tidygeocoder::geocode
)

# -----------------------------------------------------------------------------
# 4. Global Parameters/Constants
# -----------------------------------------------------------------------------

# API Keys (Store securely, ideally in environment variables)
elsevier_api_key <- Sys.getenv("ELSEVIER_API_KEY")  # Get from environment
census_api_key <- Sys.getenv("CENSUS_API_KEY") # Get from environment
google_api_key <- Sys.getenv("GOOGLE_API_KEY") # Get from environment
googlegeocode_api_key <- Sys.getenv("GOOGLEGEOCODE_API_KEY") # Get from environment

# Check if API keys are set (important for security)
if (elsevier_api_key == "") {
  stop("Elsevier API key not found. Set the ELSEVIER_API_KEY environment variable.")
}
if (census_api_key == "") {
  stop("Census API key not found. Set the CENSUS_API_KEY environment variable.")
}
if (google_api_key == "") {
  stop("Google API key not found. Set the GOOGLE_API_KEY environment variable.")
}
if (googlegeocode_api_key == "") {
  stop("Google GeoCode API key not found. Set the GOOGLEGEOCODE_API_KEY environment variable.")
}

# GIS repo (set for your own use)
gis_repo <- Sys.getenv("GIS_SHAPEFILE_REPO")

# Check if GIS repo is set
if (gis_repo == "") {
  stop("GIS shapefile repository not found. Set the GIS_SHAPEFILE_REPO environment variable using the following code: `gis_repo <- 'path/to/shapefiles/folder', or add the following code to your .Rprofile using `file.edit(file.path('~', '.Rprofile'))`: `Sys.setenv(DATA_REPO = 'path/to/shapefiles/folder')`")
}

# Data repo (set for your own use)
data_repo <- Sys.getenv("DATA_REPO")

# Check if GIS repo is set
if (data_repo == "") {
  stop("Data repository not found. Set the DATA_REPO environment variable using the following code: `data_repo <- 'path/to/data/folder'`, or add the following code to your .Rprofile using `file.edit(file.path('~', '.Rprofile'))`: `Sys.setenv(DATA_REPO = 'path/to/data/folder')`")
}

# Other Global Settings
set.seed(13) # Random seed for reproducibility
options(scipen = 9999) # Large number for scientific notation preference
sf_use_s2(FALSE) # Use sf package for spatial operations

# -----------------------------------------------------------------------------
# 5. Themes and Table Defaults
# -----------------------------------------------------------------------------

# gtsummary Themes
gtsummary::theme_gtsummary_journal(journal = "jama")
gtsummary::theme_gtsummary_compact()

# flextable Defaults (Font check!)
flextable::set_flextable_defaults(
  table.layout = "autofit", 
  font.size = 10, 
  font.family = "Times New Roman", # Ensure this font is available!
  padding.top = 0, 
  padding.bottom = 0
)

# custom color palette
mchd_county_logo_blue = "#326195"
mchd_county_logo_green = "#48773C"
mchd_green = "#385D2F"
mchd_claret = "#8C183E"
mchd_deep_saffron = "#F79232"
mchd_copper_rose = "#9b6167"
mchd_light_cerulean = "#72CCD4"

perma_list <- c("data_repo", "gis_repo", "mchd_claret", "mchd_copper_rose", "mchd_county_logo_blue", "mchd_county_logo_green", "mchd_deep_saffron", "mchd_green", "mchd_light_cerulean")

# -----------------------------------------------------------------------------
# 6. Font Loading
# -----------------------------------------------------------------------------

# Enable showtext for custom fonts
showtext::showtext_auto() 

# -----------------------------------------------------------------------------
# 7. API Key Registration
# -----------------------------------------------------------------------------

# Register API keys (after setting them as environment variables)

# tidycensus
tidycensus::census_api_key(census_api_key, overwrite = TRUE) 

# Elsevier 
rscopus::set_api_key(elsevier_api_key)  

# Google Maps 
ggmap::register_google(key = google_api_key) 

# -----------------------------------------------------------------------------
# 8.  Session Information
# -----------------------------------------------------------------------------

sessionInfo()
```

# Social Determinants of Behavioral Health

These measures are often considered causal or impactful because they reflect underlying social and environmental factors that drive behavioral health outcomes.

## Rate of Unstable Housing and Homelessness

This is a crucial measure for Multnomah County, as it's a known driver of both mental health and substance use issues. Homelessness can lead to increased stress, trauma, and a lack of access to care, while substance use and mental illness can contribute to housing instability, creating a vicious cycle.

Unstable housing can be measured in several ways, often by combining multiple indicators to get a more complete picture. The key is to move from a single metric to a continuum of housing instability.

### Homelessness (Unsheltered and Sheltered)

This is the most visible form of unstable housing.

```{r}
#| echo: false
#| error: false
#| message: false
#| warning: false

dat_homelessness <- tribble(
  ~date,        ~n,   ~category, 
  "2007-01-01", 1634, "Unsheltered",
  "2007-01-01", 2284, "Sheltered", 
  "2008-01-01", 1634, "Unsheltered", 
  "2008-01-01", 2284, "Sheltered",
  "2009-01-01", 1591, "Unsheltered",
  "2009-01-01", 2494, "Sheltered",
  "2010-01-01", 1591, "Unsheltered",
  "2010-01-01", 2644, "Sheltered",
  "2011-01-01", 1714, "Unsheltered",
  "2011-01-01", 2783, "Sheltered",
  "2012-01-01", 1714, "Unsheltered",
  "2012-01-01", 2709, "Sheltered",
  "2013-01-01", 1895, "Unsheltered",
  "2013-01-01", 2546, "Sheltered",
  "2014-01-01", 1895, "Unsheltered",
  "2014-01-01", 2032, "Sheltered",
  "2015-01-01", 1887, "Unsheltered",
  "2015-01-01", 1914, "Sheltered",
  "2016-01-01", 1887, "Unsheltered",
  "2016-01-01", 2027, "Sheltered",
  "2017-01-01", 1668, "Unsheltered",
  "2017-01-01", 2509, "Sheltered",
  "2018-01-01", 1668, "Unsheltered",
  "2018-01-01", 2351, "Sheltered",
  "2019-01-01", 2037, "Unsheltered",
  "2019-01-01", 1978, "Sheltered",
  "2020-01-01", 2037, "Unsheltered",
  "2020-01-01", 2136, "Sheltered",
  "2021-01-01", NA, "Unsheltered",
  "2021-01-01", 1780, "Sheltered",
  "2022-01-01", 3057, "Unsheltered",
  "2022-01-01", 2171, "Sheltered",
  "2023-01-01", 3944, "Unsheltered",
  "2023-01-01", 2353, "Sheltered",
  "2024-01-01", 4969, "Unsheltered",
  "2024-02-01", 5371, "Unsheltered",
  "2024-03-01", 5623, "Unsheltered",
  "2024-04-01", 5773, "Unsheltered",
  "2024-05-01", 5619, "Unsheltered",
  "2024-06-01", 5708, "Unsheltered",
  "2024-07-01", 5874, "Unsheltered",
  "2024-08-01", 5989, "Unsheltered",
  "2024-09-01", 5844, "Unsheltered",
  "2024-10-01", 5827, "Unsheltered",
  "2024-11-01", 5906, "Unsheltered",
  "2024-12-01", 5975, "Unsheltered",
  "2025-01-01", 6275, "Unsheltered",
  "2025-02-01", 6796, "Unsheltered",
  "2025-03-01", 7159, "Unsheltered",
  "2025-04-01", 7414, "Unsheltered",
  "2025-05-01", 7318, "Unsheltered",
  "2025-06-01", 7541, "Unsheltered",
  "2024-01-01", 4041, "Sheltered",
  "2024-02-01", 4123, "Sheltered",
  "2024-03-01", 4116, "Sheltered",
  "2024-04-01", 4069, "Sheltered",
  "2024-05-01", 4149, "Sheltered",
  "2024-06-01", 4161, "Sheltered",
  "2024-07-01", 4158, "Sheltered",
  "2024-08-01", 4235, "Sheltered",
  "2024-09-01", 4367, "Sheltered",
  "2024-10-01", 4617, "Sheltered",
  "2024-11-01", 4764, "Sheltered",
  "2024-12-01", 4775, "Sheltered",
  "2025-01-01", 4849, "Sheltered",
  "2025-02-01", 4860, "Sheltered",
  "2025-03-01", 4814, "Sheltered",
  "2025-04-01", 4814, "Sheltered",
  "2025-05-01", 4893, "Sheltered",
  "2025-06-01", 4818, "Sheltered", 
  "2024-01-01", 2420, "Unknown",
  "2024-02-01", 2448, "Unknown",
  "2024-03-01", 2556, "Unknown",
  "2024-04-01", 2762, "Unknown",
  "2024-05-01", 2812, "Unknown",
  "2024-06-01", 2882, "Unknown",
  "2024-07-01", 3016, "Unknown",
  "2024-08-01", 3095, "Unknown",
  "2024-09-01", 3142, "Unknown",
  "2024-10-01", 3195, "Unknown",
  "2024-11-01", 3194, "Unknown",
  "2024-12-01", 3199, "Unknown",
  "2025-01-01", 3237, "Unknown",
  "2025-02-01", 3208, "Unknown",
  "2025-03-01", 3272, "Unknown",
  "2025-04-01", 3313, "Unknown",
  "2025-05-01", 3352, "Unknown",
  "2025-06-01", 3506, "Unknown"
)
```

#### Unsheltered

People living on the streets, in vehicles, or in other places not meant for human habitation.

Source we have: <https://www.huduser.gov/portal/datasets/ahar.html>; <https://hsd.multco.us/data-dashboard/>

Source we'd like: the 'By Name List of people experiencing homelessness', Multnomah County Homeless Services Dept.

Date range available: 2007-2023 (yearly), 2024-2025 (monthly)

```{r}
#| echo: false
#| error: false
#| message: false
#| warning: false

## Data prep

# Filter data
dat_homelessness <- dat_homelessness %>%
  mutate(date = ymd(date)) %>%
  filter(category %in% c("Unsheltered", "Sheltered"))
```

```{r}
#| echo: false
#| error: false
#| message: false
#| warning: false


## Data table

# Create a flextable
dat_homelessness %>%
  filter(category == "Unsheltered") %>%
  select(-category) %>%
  flextable() %>%
  set_caption(caption = "Homelessness (Unsheltered) PIT Counts by Date") %>%
  colformat_double(j = "date", digits = 0) %>%
  set_header_labels(date = "Date", n = "Unsheltered \nCount") %>%
  bold(part = "header") %>%
  autofit() %>%
  theme_booktabs()
```

```{r}
#| echo: false
#| error: false
#| message: false
#| warning: false

## Data visualization
# Create a line chart with both categories
ggplot(dat_homelessness, aes(x = date, y = n)) +
  
  # Add a vertical dashed line at March 1, 2020
  geom_vline(
    xintercept = as.Date("2020-03-01"),
    color = "grey50",
    linetype = "dashed",
    linewidth = 0.5,
    alpha = 0.7
  ) +
  
  # Add the 'Sheltered' line and points with 50% alpha
  geom_line(data = filter(dat_homelessness, category == "Sheltered"), 
            linewidth = 1, color = "#72CCD4", alpha = 0.5) +
  geom_point(data = filter(dat_homelessness, category == "Sheltered"), 
             size = 1, color = "#72CCD4", alpha = 0.5) +
  
  # Add the 'Unsheltered' line and points
  geom_line(data = filter(dat_homelessness, category == "Unsheltered"), 
            linewidth = 1, color = "#8C183E") +
  geom_point(data = filter(dat_homelessness, category == "Unsheltered"), 
             size = 1, color = "#8C183E") +
  
  # Add a dashed line segment to indicate the data gap for Unsheltered
  geom_segment(
    aes(x = as.Date("2020-01-01"), y = 2037,
        xend = as.Date("2022-01-01"), yend = 3057),
    color = "#8C183E",
    linetype = "dashed",
    alpha = 0.5,
    linewidth = 1
  ) +
  
  # Add text labels and indicator lines for each category
  # Add the Unsheltered label
  geom_text(
    data = data.frame(
      x = as.Date("2009-01-01"),
      y = 1900,
      label = "Unsheltered"
    ),
    mapping = aes(x = x, y = y, label = label),
    inherit.aes = FALSE, 
    color = "#8C183E"
  ) + 
  
  # Add the Sheltered label
  geom_text(
    data = data.frame(
      x = as.Date("2009-01-01"),
      y = 2900,
      label = "Sheltered"
    ),
    mapping = aes(x = x, y = y, label = label),
    inherit.aes = FALSE, 
    color = "#72CCD4"
  ) +
  
  labs(title = "Trends in Homelessness Counts Over Time, \nMultnomah County",
       x = "Date",
       y = "Number of Individuals") +
  theme_minimal() +
  scale_x_date(breaks = "3 years", date_labels = "%Y") +
  theme(legend.position = "none")
```

```{r}
#| echo: false
#| error: false
#| message: false
#| warning: false

## Data visualization - Interactive Plotly Chart
library(plotly)

# Create the ggplot object
p <- ggplot(dat_homelessness, aes(x = date, y = n, color = category, 
                                           text = paste("Date:", date, "<br>Count:", n))) +
  
  # Add the 'Sheltered' line and points with 50% alpha
  geom_line(data = filter(dat_homelessness, category == "Sheltered"), 
            linewidth = 1, color = "#72CCD4", alpha = 0.5) +
  geom_point(data = filter(dat_homelessness, category == "Sheltered"), 
             size = 1, color = "#72CCD4", alpha = 0.5) +
  
  # Add the 'Unsheltered' line and points
  geom_line(data = filter(dat_homelessness, category == "Unsheltered"), 
            linewidth = 1, color = "#8C183E") +
  geom_point(data = filter(dat_homelessness, category == "Unsheltered"), 
             size = 1, color = "#8C183E") +
  
  # Add the vertical dashed line for COVID-19
  geom_vline(
    xintercept = as.Date("2020-03-01"),
    color = "grey50",
    linetype = "dashed",
    linewidth = 0.5,
    alpha = 0.7
  ) +
  
  # Add a dashed line segment to indicate the data gap for Unsheltered
  geom_segment(
    aes(x = as.Date("2020-01-01"), y = 2037,
        xend = as.Date("2022-01-01"), yend = 3057),
    color = "#8C183E",
    linetype = "dashed",
    alpha = 0.5,
    linewidth = 1
  ) +
  
  labs(title = "Trends in Homelessness Counts Over Time, \nMultnomah County",
       x = "Date",
       y = "Number of Individuals") +
  theme_minimal() +
  theme(legend.position = "none")

# Convert the ggplot object to a plotly object for interactivity
ggplotly(p, tooltip = "text")
```

#### Sheltered

People in emergency shelters, transitional housing, or domestic violence shelters.

Source: <https://www.huduser.gov/portal/datasets/ahar.html>; <https://hsd.multco.us/data-dashboard/>

Source we'd like: the 'By Name List of people experiencing homelessness', Multnomah County Homeless Services Dept.

Date range available: 2007-2023 (yearly), 2024-2025 (monthly)

### Housing Cost Burden

A household is considered "cost-burdened" if it spends more than 30% of its income on housing costs, including rent/mortgage and utilities. This can be further broken down into severely cost-burdened if the amount exceeds 50%. This is a huge indicator of housing insecurity.

### "Doubled-Up" Households

This refers to people living with friends or family because they have no other place to go. This is a hidden form of homelessness and a major sign of housing instability.

### Residential Instability

This is measured by the number of times a person or family moves within a specific period (e.g., two or more moves in a year). It indicates a lack of stable residence.

### Eviction Rates

The number of formal evictions filed in the court system is a direct measure of housing loss and a strong predictor of future homelessness.

## Unemployment Rate

High unemployment is directly correlated with increased rates of depression, anxiety, and substance use disorders. It's an economic indicator with significant behavioral health consequences.

## Access to Healthcare (Mental Health and Substance Use Treatment)

This isn't just about the number of clinics but also about patient-to-provider ratios, geographic distribution of services, and the number of people with health insurance. Audits have shown that Multnomah County's ability to serve those with serious mental illness is limited, making this an especially impactful measure.

## Community Social Cohesion and Support Networks

This can be measured through surveys or community engagement data. A strong sense of community and social support can act as a protective factor against behavioral health crises.

## Adverse Childhood Experiences (ACEs) Score

This score measures a range of childhood traumas. High ACE scores in a population are a strong predictor of poor behavioral and physical health outcomes later in life. This is a foundational, causal measure for long-term health.

# Outcome-based Behavorial Health Measures

These measures reflect the results or consequences of behavioral health issues and the effectiveness of the system in place.

## Fatal Overdose Rate (by substance, e.g., fentanyl)

This is a critical and highly-impactful measure for Multnomah County, where fentanyl-related deaths have seen a dramatic increase. It directly reflects the severity of the opioid crisis.

## Suicide Rates (by age group, gender, and race)

Suicide is a tragic and direct outcome of severe behavioral health distress. Analyzing the data by specific demographics can help identify the most vulnerable populations.

## Emergency Department Visits for Behavioral Health Crises

This measure indicates the number of people in acute distress who are not being served by the regular, community-based mental health system. A high rate suggests a fragmented or insufficient system of care.

## Mental Health-Related Civil Commitment Rates

This measures the number of individuals involuntarily placed in a treatment facility due to a mental health crisis. It can highlight gaps in preventative and community-based care.

## Criminal Justice System Involvement (mental health-related arrests)

The number of arrests and incarcerations for individuals with mental health disorders indicates a failure to provide effective, community-based support.

## Substance Use Disorder Treatment Admission and Completion Rates

This is a key measure of the system's effectiveness. High admission rates show a need for services, while low completion rates can point to barriers in treatment.

# Process and Systems-based Measures

These measures evaluate the functioning of the behavioral health system itself, focusing on how services are delivered and used.

## Wait Times for Behavioral Health Appointments

Long wait times are a significant barrier to care. This measure directly reflects the accessibility and capacity of the behavioral health system.

## Patient/Consumer Satisfaction with Behavioral Health Services

Surveying individuals who use the system can provide valuable qualitative and quantitative feedback on the quality, cultural responsiveness, and effectiveness of care.

## Retention Rates in Behavioral Health Programs

This measure tracks how long people stay engaged in treatment. High retention rates suggest that programs are effective and that clients feel supported.

## Integration of Behavioral and Physical Health Care

This measures the extent to which mental health, substance use, and physical health services are coordinated. A high level of integration leads to better overall health outcomes. It can be measured by looking at metrics like the number of individuals with co-occurring mental and physical health conditions who are seen by integrated care teams.

```{r}
#| label: end


```
